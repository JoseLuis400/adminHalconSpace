<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ControlMission - Panel de Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0a1e 0%, #1a0f2e 100%);
            color: #fff;
            overflow-x: hidden;
        }

        /* Modal de ID */
        #idModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        #idModal.hidden {
            display: none;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e1833 0%, #12101d 100%);
            border: 2px solid #7c3aed;
            border-radius: 20px;
            padding: 50px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 0 50px rgba(124, 58, 237, 0.3);
            animation: modalAppear 0.5s ease;
        }

        @keyframes modalAppear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .modal-title {
            font-size: 32px;
            font-weight: bold;
            color: #a78bfa;
            margin-bottom: 10px;
            text-shadow: 0 0 20px rgba(167, 139, 250, 0.5);
        }

        .modal-subtitle {
            font-size: 16px;
            color: #9ca3af;
            margin-bottom: 30px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            text-align: left;
            color: #a78bfa;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .input-group input {
            width: 100%;
            padding: 15px;
            background: rgba(124, 58, 237, 0.1);
            border: 2px solid #7c3aed;
            border-radius: 10px;
            color: #fff;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            background: rgba(124, 58, 237, 0.2);
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.3);
        }

        .btn-submit {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 25px rgba(124, 58, 237, 0.5);
        }

        .error-message {
            color: #ff3366;
            font-size: 14px;
            margin-top: 10px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Contenedor principal */
        #mainContainer {
            display: none;
        }

        #mainContainer.visible {
            display: block;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid #7c3aed;
            margin-bottom: 30px;
            position: relative;
        }

        h1 {
            font-size: 3em;
            color: #a78bfa;
            text-shadow: 0 0 20px rgba(167, 139, 250, 0.5);
            margin-bottom: 10px;
        }

        .header-subtitle {
            color: #9ca3af;
            font-size: 0.9em;
        }

        .btn-change-mission {
            position: absolute;
            top: 30px;
            right: 20px;
            padding: 10px 20px;
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            border-radius: 10px;
            color: #ef4444;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-change-mission:hover {
            background: rgba(239, 68, 68, 0.3);
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }

        .mission-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-card {
            background: rgba(124, 58, 237, 0.05);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .info-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
        }

        .info-label {
            font-size: 0.9em;
            color: #9ca3af;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .info-value {
            font-size: 2em;
            font-weight: bold;
            color: #a78bfa;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        .status-active {
            background: rgba(34, 197, 94, 0.2);
            border: 2px solid #22c55e;
            color: #22c55e;
        }

        .status-standby {
            background: rgba(251, 191, 36, 0.2);
            border: 2px solid #fbbf24;
            color: #fbbf24;
        }

        .status-scrub {
            background: rgba(239, 68, 68, 0.2);
            border: 2px solid #ef4444;
            color: #ef4444;
        }

        .telemetry-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .telemetry-card {
            background: rgba(30, 24, 51, 0.8);
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 15px;
            padding: 25px;
            backdrop-filter: blur(10px);
        }

        .telemetry-card h3 {
            color: #a78bfa;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid rgba(124, 58, 237, 0.3);
            padding-bottom: 10px;
        }

        .telemetry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .telemetry-item:last-child {
            border-bottom: none;
        }

        .telemetry-label {
            color: #9ca3af;
            font-size: 0.95em;
        }

        .telemetry-value {
            color: #c4b5fd;
            font-weight: bold;
            font-size: 1.2em;
        }

        .propellant-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
            position: relative;
        }

        .propellant-fill {
            height: 100%;
            background: linear-gradient(90deg, #7c3aed, #5b21b6);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-weight: bold;
            font-size: 0.9em;
        }

        .propellant-section {
            margin-bottom: 20px;
        }

        .propellant-title {
            color: #a78bfa;
            font-size: 0.9em;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .small {
            font-size: 0.8em;
            color: #a0c4ff;
            font-weight: normal;
            opacity: 0.8;
            text-align: center;
        }

        .counter-display {
            font-family: 'Courier New', monospace;
            font-size: 3em;
            letter-spacing: 3px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid;
            font-size: 0.9em;
            z-index: 100;
        }

        .connected {
            border-color: #22c55e;
            color: #22c55e;
        }

        .disconnected {
            border-color: #ef4444;
            color: #ef4444;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }
            .counter-display {
                font-size: 2em;
            }
            .btn-change-mission {
                position: static;
                margin-top: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de ID -->
    <div id="idModal">
        <div class="modal-content">
            <h1 class="modal-title">CONTROL MISSION</h1>
            <p class="modal-subtitle">Sistema de Telemetr√≠a en Tiempo Real</p>
            
            <form id="missionForm">
                <div class="input-group">
                    <label for="missionId">ID de Misi√≥n</label>
                    <input 
                        type="text" 
                        id="missionId" 
                        placeholder="Ingresa el ID de la misi√≥n"
                        autocomplete="off"
                        required
                    >
                </div>
                <button type="submit" class="btn-submit">Iniciar Monitoreo</button>
                <div class="error-message" id="errorMessage">ID de misi√≥n inv√°lido</div>
            </form>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div id="mainContainer">
        <div class="connection-status" id="connectionStatus">
            üî¥ Desconectado
        </div>

        <div class="container">
            <header>
                <button class="btn-change-mission" id="btnChangeMission">Cambiar Misi√≥n</button>
                <h1>CONTROL MISSION</h1>
                <p class="header-subtitle" id="missionIdDisplay">Sistema de Telemetr√≠a en Tiempo Real</p>
            </header>

            <div class="mission-info">
                <div class="info-card">
                    <div class="info-label">Contador de Misi√≥n</div>
                    <div class="info-value counter-display" id="missionCounter">T+00:00:00</div>
                </div>
                <div class="info-card">
                    <div class="info-label">Estado</div>
                    <div class="info-value">
                        <span class="status-badge status-active" id="missionStatus">CARGANDO</span>
                    </div>
                </div>
                <div class="info-card">
                    <div class="info-label">Nombre de Misi√≥n</div>
                    <div class="info-value" id="missionName" style="font-size: 1.5em;">---</div>
                </div>
            </div>

            <div class="telemetry-grid">
                <div class="telemetry-card">
                    <h3>üì° Par√°metros Orbitales</h3>
                    <div class="telemetry-item">
                        <span class="telemetry-label">Altitud</span>
                        <span class="telemetry-value" id="altitude">0 m</span>
                    </div>
                    <div class="telemetry-item">
                        <span class="telemetry-label">Apogeo</span>
                        <span class="telemetry-value" id="apogeo">0 km</span>
                    </div>
                    <div class="telemetry-item">
                        <span class="telemetry-label">Perigeo</span>
                        <span class="telemetry-value" id="perigeo">0 km</span>
                    </div>
                    <div class="telemetry-item">
                        <span class="telemetry-label">Inclinaci√≥n</span>
                        <span class="telemetry-value" id="inclination">0¬∞</span>
                    </div>
                </div>

                <div class="telemetry-card">
                    <h3>üöÄ Velocidad y Posici√≥n</h3>
                    <div class="telemetry-item">
                        <span class="telemetry-label">Velocidad</span>
                        <span class="telemetry-value" id="velocity">0 km/h</span>
                    </div>
                    <div class="telemetry-item">
                        <span class="telemetry-label">Velocidad Orbital</span>
                        <span class="telemetry-value" id="orbitalVelocity">0 m/s</span>
                    </div>
                </div>

                <div class="telemetry-card">
                    <h3>‚õΩ Propelente</h3>
                    
                    <div class="propellant-section">
                        <div class="propellant-title">Queroseno (RP-1)</div>
                        <div class="propellant-bar">
                            <div class="propellant-fill" id="propellantPL">0%</div>
                        </div>
                        <div class="small" id="cantidadPropellantPL"></div>
                    </div>

                    <div class="propellant-section">
                        <div class="propellant-title">Ox√≠geno L√≠quido (LOx)</div>
                        <div class="propellant-bar">
                            <div class="propellant-fill" id="propellantOX">0%</div>
                        </div>
                        <div class="small" id="cantidadPropellantOX"></div>
                    </div>

                    <div class="propellant-section">
                        <div class="propellant-title">Energ√≠a El√©ctrica (kWh)</div>
                        <div class="propellant-bar">
                            <div class="propellant-fill" id="propellantCE">0%</div>
                        </div>
                        <div class="small" id="cantidadPropellantCE"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAiLw2zwfsjdMP-IlEoE5JugyFvmaQLFC0",
            authDomain: "halcon-space-348e7.firebaseapp.com",
            projectId: "halcon-space-348e7",
            storageBucket: "halcon-space-348e7.firebasestorage.app",
            messagingSenderId: "741724706453",
            appId: "1:741724706453:web:519531e63f2b923f952d9c",
            measurementId: "G-VG1Y2YMY4W"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentMissionId = null;
        let telemetryUnsubscribe = null;
        let missionUnsubscribe = null;
        let contadorInterval = null;
        let telemetryData = {};
        let lanzamiento = { 
            estado: "preparacion", 
            holdTime: null, 
            fecha: "", 
            timeUTC: "" 
        };

        // Funci√≥n para calcular el tiempo (T-/T+)
        function calcularContador(fechaStr, timeStr, now = null) {
            if (!fechaStr || !timeStr) return "T+00:00:00";
            
            const [dia, mes, anio] = fechaStr.split("/").map(Number);
            const [h, m, s] = timeStr.split(":").map(Number);
            const launchDate = new Date(Date.UTC(anio, mes - 1, dia, h, m, s));
            const currentTime = now ? new Date(now) : new Date();
            let diff = Math.floor((launchDate - currentTime) / 1000);
            let signo = diff >= 0 ? "T-" : "T+";
            diff = Math.abs(diff);
            const dias = Math.floor(diff / 86400);
            const horas = String(Math.floor((diff % 86400) / 3600)).padStart(2, "0");
            const minutos = String(Math.floor((diff % 3600) / 60)).padStart(2, "0");
            const segundos = String(diff % 60).padStart(2, "0");
            return dias > 0 ? `${signo}${dias}D ${horas}:${minutos}:${segundos}` : `${signo}${horas}:${minutos}:${segundos}`;
        }

        // Funci√≥n para actualizar el contador en el DOM
        function actualizarContador() {
            const missionTimeSpan = document.getElementById("missionCounter");
            let now = new Date();

            // Si es SCRUB o HOLD, usar el tiempo guardado en holdTime
            if (lanzamiento.estado?.toLowerCase() === "scrub" || lanzamiento.estado?.toLowerCase() === "hold") {
                if (lanzamiento.holdTime) {
                    now = new Date(lanzamiento.holdTime);
                }
            }

            const nuevoTexto = calcularContador(lanzamiento.fecha, lanzamiento.timeUTC, now);
            missionTimeSpan.textContent = nuevoTexto;
        }

        // Funci√≥n para iniciar/parar el contador
        function iniciarContador() {
            if (contadorInterval) clearInterval(contadorInterval);
            actualizarContador();

            // Solo seguir actualizando si NO es SCRUB
            if (lanzamiento.estado?.toLowerCase() !== "scrub") {
                contadorInterval = setInterval(actualizarContador, 1000);
            }
        }
        // Actualizar telemetr√≠a en pantalla
        function updateTelemetryDisplay() {
            document.getElementById('altitude').textContent = (telemetryData.altitude_m3 || 0).toLocaleString() + ' m';
            document.getElementById('apogeo').textContent = (telemetryData.apogeo || 0).toLocaleString() + ' km';
            document.getElementById('perigeo').textContent = (telemetryData.perigeo || 0).toLocaleString() + ' km';
            document.getElementById('inclination').textContent = (telemetryData.inclination || 0).toFixed(2) + '¬∞';
            document.getElementById('velocity').textContent = (telemetryData.velocity_kmh || 0).toLocaleString() + ' km/h';
            document.getElementById('cantidadPropellantPL').textContent =
    (telemetryData.propelente_pl || 0).toLocaleString() + " / " +
    (telemetryData.propelente_maxpl || 0).toLocaleString() + " L";

document.getElementById('cantidadPropellantOX').textContent =
    (telemetryData.propelente_ox || 0).toLocaleString() + " / " +
    (telemetryData.propelente_maxox || 0).toLocaleString() + " L";

document.getElementById('cantidadPropellantCE').textContent =
    (telemetryData.propelente_ce || 0).toLocaleString() + " / " +
    (telemetryData.propelente_maxce || 0).toLocaleString() + " kWh";

            
            // Calcular velocidad orbital en m/s
            const orbitalVel = telemetryData.velocity_kmh ? (telemetryData.velocity_kmh * 1000 / 3600).toFixed(2) : 0;
            document.getElementById('orbitalVelocity').textContent = orbitalVel + ' m/s';

            // Actualizar barras de propelente
            updatePropellantBar('propellantPL', telemetryData.propelente_pl, telemetryData.propelente_maxpl);
            updatePropellantBar('propellantOX', telemetryData.propelente_ox, telemetryData.propelente_maxox);
            updatePropellantBar('propellantCE', telemetryData.propelente_ce, telemetryData.propelente_maxce);
        }

        function updatePropellantBar(elementId, current, max) {
            const element = document.getElementById(elementId);
            if (element && max && max > 0) {
                const percentage = Math.min(100, (current / max) * 100);
                element.style.width = percentage + '%';
                element.textContent = percentage.toFixed(1) + '%';
            } else {
                element.style.width = '0%';
                element.textContent = '0%';
            }
        }

        function showError(message) {
            const errorMsg = document.getElementById('errorMessage');
            errorMsg.textContent = message;
            errorMsg.classList.add('show');
            setTimeout(() => {
                errorMsg.classList.remove('show');
            }, 3000);
        }

        // Verificar ID en URL
        const urlParams = new URLSearchParams(window.location.search);
        const urlMissionId = urlParams.get('id');

        if (urlMissionId) {
            document.getElementById('missionId').value = urlMissionId;
            startMission(urlMissionId);
        }

        // Form de misi√≥n
        document.getElementById('missionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const missionId = document.getElementById('missionId').value.trim();
            
            if (!missionId) {
                showError('Por favor ingresa un ID de misi√≥n');
                return;
            }

            startMission(missionId);
        });

        function startMission(missionId) {
            currentMissionId = missionId;
            
            // Actualizar URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('id', missionId);
            window.history.pushState({}, '', newUrl);

            // Ocultar modal y mostrar contenedor
            document.getElementById('idModal').classList.add('hidden');
            document.getElementById('mainContainer').classList.add('visible');
            
            // Actualizar nombre en header
            document.getElementById('missionIdDisplay').textContent = `Cargando misi√≥n...`;

            // Cargar datos de la misi√≥n
            loadMissionData(missionId);
        }

        function loadMissionData(missionId) {
            const missionRef = doc(db, 'lanzamientos', missionId);
            
            if (missionUnsubscribe) {
                missionUnsubscribe();
            }

            missionUnsubscribe = onSnapshot(missionRef, (docSnap) => {
                if (docSnap.exists()) {
                    const missionData = docSnap.data();
                    
                    // Actualizar datos del lanzamiento
                    lanzamiento = {
                        estado: missionData.estado || "preparacion",
                        holdTime: missionData.holdTime || null,
                        fecha: missionData.fecha || "",
                        timeUTC: missionData.timeUTC || "00:00:00"
                    };

                    // Actualizar nombre
                    if (missionData.nombre) {
                        document.getElementById('missionName').textContent = missionData.nombre;
                        document.getElementById('missionIdDisplay').textContent = missionData.nombre;
                    } else {
                        document.getElementById('missionIdDisplay').textContent = `Misi√≥n: ${missionId}`;
                    }

                    // Actualizar estado
                    const statusElement = document.getElementById('missionStatus');
                    statusElement.textContent = lanzamiento.estado.toUpperCase();
                    
                    // Cambiar color seg√∫n estado
                    statusElement.className = 'status-badge';
                    if (lanzamiento.estado.toLowerCase() === 'activo' || lanzamiento.estado.toLowerCase() === 'en vuelo') {
                        statusElement.classList.add('status-active');
                    } else if (lanzamiento.estado.toLowerCase() === 'scrub') {
                        statusElement.classList.add('status-scrub');
                    } else {
                        statusElement.classList.add('status-standby');
                    }

                    // Iniciar contador
                    if (lanzamiento.fecha && lanzamiento.timeUTC) {
                        iniciarContador();
                    }

                    // Verificar telemetr√≠a
                    const telemetryActive = missionData.telemetria_on === true;
                    if (telemetryActive) {
                        startTelemetryListener();
                    } else {
                        document.getElementById('connectionStatus').textContent = '‚ö†Ô∏è Telemetr√≠a Desactivada';
                        document.getElementById('connectionStatus').className = 'connection-status';
                        document.getElementById('connectionStatus').style.borderColor = '#ffc107';
                        document.getElementById('connectionStatus').style.color = '#ffc107';
                    }
                } else {
                    showError('Misi√≥n no encontrada');
                    document.getElementById('connectionStatus').textContent = 'üî¥ Misi√≥n No Encontrada';
                    document.getElementById('connectionStatus').className = 'connection-status disconnected';
                }
            }, (error) => {
                console.error('Error al cargar misi√≥n:', error);
                showError('Error al conectar con la misi√≥n');
            });
        }

        function startTelemetryListener() {
            if (telemetryUnsubscribe) {
                telemetryUnsubscribe();
            }

            const telemetryRef = doc(db, 'telemetria', 'estado_actual');
            
            telemetryUnsubscribe = onSnapshot(telemetryRef, (docSnap) => {
                const statusElement = document.getElementById('connectionStatus');
                
                if (docSnap.exists()) {
                    statusElement.textContent = 'üü¢ Conectado';
                    statusElement.className = 'connection-status connected';
                    
                    const data = docSnap.data();
                    telemetryData = {
                        altitude_m3: data.altitude_m || 0,
                        apogeo: data.apogeo || 0,
                        inclination: data.inclination || 0,
                        perigeo: data.perigeo || 0,
                        velocity_kmh: data.velocity_kmh || 0,
                        propelente_pl: data.propelente?.pl || 0,
                        propelente_ox: data.propelente?.ox || 0,
                        propelente_ce: data.propelente?.ce || 0,
                        propelente_maxpl: data.propelente?.maxpl || 100,
                        propelente_maxox: data.propelente?.maxox || 100,
                        propelente_maxce: data.propelente?.maxce || 100
                    };
                    updateTelemetryDisplay();
                } else {
                    statusElement.textContent = 'üü° Sin Datos';
                    statusElement.className = 'connection-status';
                    statusElement.style.borderColor = '#ffc107';
                    statusElement.style.color = '#ffc107';
                }
            }, (error) => {
                console.error('Error en telemetr√≠a:', error);
                const statusElement = document.getElementById('connectionStatus');
                statusElement.textContent = 'üî¥ Error';
                statusElement.className = 'connection-status disconnected';
            });
        }

        // Bot√≥n cambiar misi√≥n
        document.getElementById('btnChangeMission').addEventListener('click', () => {
            if (telemetryUnsubscribe) {
                telemetryUnsubscribe();
            }
            if (missionUnsubscribe) {
                missionUnsubscribe();
            }
            if (contadorInterval) {
                clearInterval(contadorInterval);
            }
            document.getElementById('idModal').classList.remove('hidden');
            document.getElementById('mainContainer').classList.remove('visible');
            document.getElementById('missionId').value = '';
            
            // Limpiar URL
            const newUrl = new URL(window.location);
            newUrl.searchParams.delete('id');
            window.history.pushState({}, '', newUrl);
        });
    </script>
</body>
</html>