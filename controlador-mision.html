<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel de Control de Lanzamiento</title>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAiLw2zwfsjdMP-IlEoE5JugyFvmaQLFC0",
  authDomain: "halcon-space-348e7.firebaseapp.com",
  projectId: "halcon-space-348e7",
  storageBucket: "halcon-space-348e7.firebasestorage.app",
  messagingSenderId: "741724706453",
  appId: "1:741724706453:web:519531e63f2b923f952d9c",
  measurementId: "G-VG1Y2YMY4W"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let lanzamientoId = null;
let misionActual = null;
let contadorInterval = null;
let tiempoCongelado = null;

const capitalize = str => str ? str.charAt(0).toUpperCase() + str.slice(1) : "";

function getLaunchUTC(fechaStr, timeStr) {
  const [day, month, year] = fechaStr.split("/").map(Number);
  const [hours = 0, minutes = 0, seconds = 0] = (timeStr || "00:00:00").split(":").map(Number);
  return new Date(Date.UTC(year, month - 1, day, hours, minutes, seconds));
}

function calcularContador(fechaStr, timeStr, ahora = new Date()) {
  const lanzamiento = getLaunchUTC(fechaStr, timeStr);
  let diff = lanzamiento - ahora;
  let signo = "T-";
  if(diff < 0){
    signo = "T+";
    diff = Math.abs(diff);
  }
  const dias = Math.floor(diff / 86400000);
  const horas = String(Math.floor((diff % 86400000) / 3600000)).padStart(2, "0");
  const minutos = String(Math.floor((diff % 3600000) / 60000)).padStart(2, "0");
  const segundos = String(Math.floor((diff % 60000) / 1000)).padStart(2, "0");
  return dias > 0 ? `${signo}${dias}d ${horas}:${minutos}:${segundos}` : `${signo}${horas}:${minutos}:${segundos}`;
}

document.addEventListener("DOMContentLoaded", async () => {
  const selector = document.getElementById("selectorMision");
  const form = document.getElementById("formT0");
  const estadoElem = document.getElementById("estadoActual");
  const contadorElem = document.getElementById("contadorActual");
  const holdTimeElem = document.getElementById("holdTime");
  const switchTelemetria = document.getElementById("switchTelemetria");
  const labelTelemetria = document.getElementById("labelTelemetria");
  const idElem = document.getElementById("lanzamientoId");

  // ===== Cargar misiones desde Firestore =====
  const snap = await getDocs(collection(db, "lanzamientos"));
  let misiones = snap.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

  misiones.sort((a,b) => getLaunchUTC(b.fecha, b.timeUTC || "00:00:00") - getLaunchUTC(a.fecha, a.timeUTC || "00:00:00"));

  misiones.forEach(m => {
    const option = document.createElement("option");
    option.value = m.id;
    option.textContent = `${m.nombre} (${m.fecha} - ${m.timeUTC + " UTC" || ""})`;
    selector.appendChild(option);
  });

  if(misiones.length > 0){
    lanzamientoId = misiones[0].id;
    selector.value = lanzamientoId;
    cargarDatosMision(misiones[0]);
  }

  selector.addEventListener("change", e => {
    lanzamientoId = e.target.value;
    idElem.textContent = `ID Seleccionado: ${lanzamientoId}`;
    const m = misiones.find(m => m.id === lanzamientoId);
    if(m) cargarDatosMision(m);
  });

  function cargarDatosMision(mision){
    misionActual = mision;
    idElem.textContent = `ID Seleccionado: ${mision.id}`;

    form.fecha.value = mision.fecha.split("/").reverse().join("-");
    form.hora.value = mision.timeUTC || "00:00:00";

    estadoElem.textContent = capitalize(mision.estado || "Desconocido");
    holdTimeElem.textContent = mision.holdTime ? `Hora HOLD/SCRUB: ${mision.holdTime}` : "";

    if(contadorInterval) clearInterval(contadorInterval);
    tiempoCongelado = (mision.estado === "hold" || mision.estado === "scrub") ? (mision.holdTime ? new Date(mision.holdTime) : new Date()) : null;
    contadorInterval = setInterval(() => {
      const ahora = tiempoCongelado ? new Date(tiempoCongelado) : new Date();
      contadorElem.textContent = calcularContador(misionActual.fecha, misionActual.timeUTC, ahora);
    }, 1000);

    // Actualizar switch telemetr√≠a
    switchTelemetria.checked = mision.telemetria_on ?? false;
    labelTelemetria.textContent = switchTelemetria.checked ? "Telemetr√≠a ACTIVADA" : "Telemetr√≠a DESACTIVADA";
  }

    // ===== Acciones r√°pidas =====
    const botonesEstado = document.querySelectorAll("button[data-estado]");
  const reciclarBtn = document.getElementById("reciclarBtn");

  botonesEstado.forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!misionActual) return alert("‚ö†Ô∏è Selecciona una misi√≥n primero");
      const nuevoEstado = btn.dataset.estado;

      let updateData = { estado: nuevoEstado };

      // Si es HOLD guardamos la hora del evento
      if (nuevoEstado === "hold") {
        updateData.holdTime = new Date().toISOString();
      } else {
        updateData.holdTime = null;
      }

      await updateDoc(doc(db, "lanzamientos", misionActual.id), updateData);

      misionActual.estado = nuevoEstado;
      misionActual.holdTime = updateData.holdTime;

      document.getElementById("estadoActual").textContent = nuevoEstado.toUpperCase();
      document.getElementById("holdTime").textContent =
        updateData.holdTime ? `Hora HOLD/SCRUB: ${new Date(updateData.holdTime).toLocaleString()}` : "";

      console.log(`‚úÖ Estado actualizado a: ${nuevoEstado}`);
    });
  });

  // Reciclar ‚Üí volver al estado programado y resetear holdTime
  reciclarBtn.addEventListener("click", async () => {
    if (!misionActual) return alert("‚ö†Ô∏è Selecciona una misi√≥n primero");

    await updateDoc(doc(db, "lanzamientos", misionActual.id), {
      estado: "programado",
      holdTime: null
    });

    misionActual.estado = "programado";
    misionActual.holdTime = null;

    document.getElementById("estadoActual").textContent = "Programado";
    document.getElementById("holdTime").textContent = "";

    console.log("‚ôªÔ∏è Lanzamiento reciclado a 'Programado'");
  });


  // ===== Switch Telemetr√≠a =====
  switchTelemetria.addEventListener("change", async () => {
    if(!misionActual) return alert("‚ö†Ô∏è Selecciona una misi√≥n primero");
    const nuevoEstado = switchTelemetria.checked;
    await updateDoc(doc(db, "lanzamientos", misionActual.id), {
      telemetria_on: nuevoEstado
    });
    labelTelemetria.textContent = nuevoEstado ? "Telemetr√≠a ACTIVADA" : "Telemetr√≠a DESACTIVADA";
    misionActual.telemetria_on = nuevoEstado;
    console.log(`‚úÖ Telemetr√≠a ${nuevoEstado ? "activada" : "desactivada"}`);
  });

  form.addEventListener("submit", async e => {
    e.preventDefault();
    if(!lanzamientoId) return alert("‚ö†Ô∏è Selecciona una misi√≥n primero");

    const fecha = form.fecha.value.split("-").reverse().join("/");
    const hora = form.hora.value;
    const utcTime = getLaunchUTC(fecha, hora).toISOString();

    await updateDoc(doc(db, "lanzamientos", lanzamientoId), {
      fecha,
      timeUTC: hora,
      utcTime
    });

    console.log("‚úÖ T-0 actualizado");
  });
});
  </script>

  <style>
body {
  font-family: Arial, sans-serif;
  background: #0d0d0d;
  color: #f1f1f1;
  text-align: center;
  padding: 2rem;
}

h1 { 
  margin-bottom: 1rem; 
}

select, input { 
  padding: 0.5rem; 
  margin: 0.3rem; 
  border-radius: 4px; 
  border: none; 
  font-size: 1rem; 
}

button { 
  margin: 0.4rem; 
  padding: 0.6rem 1rem; 
  border: none; 
  border-radius: 4px; 
  font-weight: bold; 
  cursor: pointer; 
}

.programado { background: #0066ff; color: #fff; }
.hold { background: #ffcc00; color: #000; }
.scrub { background: #ff4444; }
.exito { background: #00cc66; }
.fallo { background: #990000; }
.envuelo { background: #0066ff; }

#contadorActual { 
  font-size: 2rem; 
  margin: 1rem 0; 
  font-weight: bold; 
}

#holdTime { 
  font-size: 1rem; 
  margin-bottom: 1rem; 
  color: #ffcc00; 
}

#switchContainer { 
  margin: 1rem 0; 
  display: flex; 
  justify-content: center; 
  align-items: center; 
  gap: 0.5rem;
}

/* Switch estilo moderno */
.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0;
  right: 0; bottom: 0;
  background-color: #ccc;
  transition: 0.4s;
  border-radius: 34px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px; 
  width: 26px;
  left: 4px; 
  bottom: 4px;
  background-color: white;
  transition: 0.4s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #00cc66; /* verde cuando activado */
}

input:focus + .slider {
  box-shadow: 0 0 1px #00cc66;
}

input:checked + .slider:before {
  transform: translateX(26px);
}

#labelTelemetria {
  font-weight: bold;
  vertical-align: middle;
  font-size: 1rem;
  color: #ff4444; /* rojo por defecto desactivado */
}

/* Estilo para mostrar ID del lanzamiento */
#lanzamientoId {
  font-size: 0.9rem; 
  color: #00ffcc; 
  margin-bottom: 1rem; 
  display: block; 
}

/* Formulario de T-0 */
form {
  background: #1a1a1a;
  padding: 1rem;
  border-radius: 6px;
  margin-bottom: 1rem;
  display: inline-block;
}

input[type="date"], input[type="time"] {
  width: 150px;
}

  </style>
</head>
<body>
  <h1>üöÄ Panel de Control de Lanzamiento</h1>

  <div>
    <label for="selectorMision"><strong>Seleccionar misi√≥n:</strong></label>
    <br>
    <select id="selectorMision">
      <option value="">-- Selecciona una misi√≥n --</option>
    </select>
  </div>

  <p id="lanzamientoId">ID Seleccionado: --</p>

  <div id="switchContainer">
    <input type="checkbox" id="switchTelemetria">
    <span id="labelTelemetria">Telemetr√≠a DESACTIVADA</span>
  </div>

  <p><strong>Estado actual:</strong> <span id="estadoActual">Desconocido</span></p>
  <p id="contadorActual"></p>
  <p id="holdTime"></p>

  <form id="formT0">
    <h2>Modificar T-0</h2>
    <label>Fecha (UTC): <input type="date" name="fecha" required></label>
    <label>Hora (UTC): <input type="time" step="1" name="hora" required></label>
    <button type="submit">Actualizar T-0</button>
  </form>

  <div>
    <h2>Acciones r√°pidas</h2>
    <button class="programado" data-estado="programado">Programado</button>
    <button class="hold" data-estado="hold">HOLD</button>
    <button class="scrub" data-estado="scrub">SCRUB</button>
    <button id="reciclarBtn" class="programado">Reciclar</button>
    <button class="exito" data-estado="exito">√âxito</button>
    <button class="fallo" data-estado="fallo">Fallo</button>
    <button class="envuelo" data-estado="en vuelo">En vuelo</button>
  </div>
</body>
</html>
