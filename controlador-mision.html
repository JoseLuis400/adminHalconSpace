<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Control de Lanzamiento</title>
  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAiLw2zwfsjdMP-IlEoE5JugyFvmaQLFC0",
  authDomain: "halcon-space-348e7.firebaseapp.com",
  projectId: "halcon-space-348e7",
  storageBucket: "halcon-space-348e7.firebasestorage.app",
  messagingSenderId: "741724706453",
  appId: "1:741724706453:web:519531e63f2b923f952d9c",
  measurementId: "G-VG1Y2YMY4W"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let lanzamientoId = null;
let misionActual = null;
let contadorInterval = null;
let tiempoCongelado = null;
let unsubscribe = null;

const capitalize = str => str ? str.charAt(0).toUpperCase() + str.slice(1) : "";

function getLaunchUTC(fechaStr, timeStr) {
  const [day, month, year] = fechaStr.split("/").map(Number);
  const [hours = 0, minutes = 0, seconds = 0] = (timeStr || "00:00:00").split(":").map(Number);
  return new Date(Date.UTC(year, month - 1, day, hours, minutes, seconds));
}

function calcularContador(fechaStr, timeStr, ahora = new Date()) {
  const lanzamiento = getLaunchUTC(fechaStr, timeStr);
  let diff = lanzamiento - ahora;
  let signo = "T-";
  if(diff < 0){
    signo = "T+";
    diff = Math.abs(diff);
  }
  const dias = Math.floor(diff / 86400000);
  const horas = String(Math.floor((diff % 86400000) / 3600000)).padStart(2, "0");
  const minutos = String(Math.floor((diff % 3600000) / 60000)).padStart(2, "0");
  const segundos = String(Math.floor((diff % 60000) / 1000)).padStart(2, "0");
  
  if(dias > 0) {
    return `${signo}${dias}D / ${horas}:${minutos}:${segundos}`;
  }
  return `${signo}${horas}:${minutos}:${segundos}`;
}

function mostrarNotificacion(mensaje, tipo = 'success') {
  const notif = document.getElementById('notificacion');
  notif.textContent = mensaje;
  notif.className = `notificacion ${tipo}`;
  notif.style.display = 'block';
  setTimeout(() => notif.style.display = 'none', 3000);
}

function formatearFechaHora(isoString) {
  if (!isoString) return '';
  const d = new Date(isoString);
  const fecha = d.toISOString().split('T')[0];
  const hora = d.toISOString().split('T')[1].substring(0, 8);
  return { fecha, hora };
}

document.addEventListener("DOMContentLoaded", async () => {
  const selector = document.getElementById("selectorMision");
  const form = document.getElementById("formT0");
  const estadoElem = document.getElementById("estadoActual");
  const contadorElem = document.getElementById("contadorDisplay");
  const holdTimeElem = document.getElementById("holdTime");
  const switchTelemetria = document.getElementById("switchTelemetria");
  const labelTelemetria = document.getElementById("labelTelemetria");
  const lanzamientoIdElem = document.getElementById("lanzamientoId");
  const formWindow = document.getElementById("formWindow");
  const windowDisplay = document.getElementById("windowDisplay");
  const btnEliminarWindow = document.getElementById("btnEliminarWindow");
  const windowSection = document.getElementById("windowSection");

  // Click para copiar ID
  lanzamientoIdElem.addEventListener("click", () => {
    if (lanzamientoId) {
      navigator.clipboard.writeText(lanzamientoId).then(() => {
        mostrarNotificacion("üìã ID copiado", 'success');
      });
    }
  });

  const snap = await getDocs(collection(db, "lanzamientos"));
  let misiones = snap.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
  misiones.sort((a,b) => getLaunchUTC(b.fecha, b.timeUTC || "00:00:00") - getLaunchUTC(a.fecha, a.timeUTC || "00:00:00"));

  misiones.forEach(m => {
    const option = document.createElement("option");
    option.value = m.id;
    option.textContent = `${m.nombre} (${m.fecha})`;
    selector.appendChild(option);
  });

  if(misiones.length > 0){
    lanzamientoId = misiones[0].id;
    selector.value = lanzamientoId;
    cargarDatosMision(misiones[0]);
  }

  selector.addEventListener("change", e => {
    lanzamientoId = e.target.value;
    const m = misiones.find(m => m.id === lanzamientoId);
    if(m) cargarDatosMision(m);
  });

  function actualizarVistaWindow(window) {
    if (!window || window === null) {
      windowDisplay.style.display = 'none';
      formWindow.style.display = 'block';
      btnEliminarWindow.style.display = 'none';
      formWindow.reset();
    } else {
      windowDisplay.style.display = 'block';
      formWindow.style.display = 'none';
      btnEliminarWindow.style.display = 'block';
      
      const inicio = new Date(window.start);
      const fin = new Date(window.end);
      
      document.getElementById('windowStart').textContent = inicio.toLocaleString('es-UY');
      document.getElementById('windowEnd').textContent = fin.toLocaleString('es-UY');
      
      const duracion = Math.abs(fin - inicio);
      const minutos = Math.floor(duracion / 60000);
      document.getElementById('windowDuration').textContent = `${minutos} min`;
    }
  }

  function cargarDatosMision(mision){
    misionActual = mision;
    lanzamientoIdElem.textContent = mision.id;
    form.fecha.value = mision.fecha.split("/").reverse().join("-");
    form.hora.value = mision.timeUTC || "00:00:00";

    estadoElem.textContent = capitalize(mision.estado || "Desconocido");
    estadoElem.className = `badge ${mision.estado || "desconocido"}`;
    
    holdTimeElem.textContent = mision.holdTime ? `‚è∏Ô∏è ${new Date(mision.holdTime).toLocaleString('es-UY')}` : "";

    if(contadorInterval) clearInterval(contadorInterval);
    tiempoCongelado = (mision.estado === "hold" || mision.estado === "scrub") ? (mision.holdTime ? new Date(mision.holdTime) : new Date()) : null;
    
    contadorInterval = setInterval(() => {
      const ahora = tiempoCongelado ? new Date(tiempoCongelado) : new Date();
      contadorElem.textContent = calcularContador(misionActual.fecha, misionActual.timeUTC, ahora);
    }, 1000);

    switchTelemetria.checked = mision.telemetria_on ?? false;
    labelTelemetria.textContent = switchTelemetria.checked ? "ON" : "OFF";

    // Actualizar vista de ventana
    actualizarVistaWindow(mision.window);

    if(unsubscribe) unsubscribe();
    unsubscribe = onSnapshot(doc(db, "lanzamientos", mision.id), (docSnap) => {
      if(docSnap.exists()) {
        const data = docSnap.data();
        misionActual = { id: docSnap.id, ...data };
        estadoElem.textContent = capitalize(data.estado || "Desconocido");
        estadoElem.className = `badge ${data.estado || "desconocido"}`;
        switchTelemetria.checked = data.telemetria_on ?? false;
        labelTelemetria.textContent = switchTelemetria.checked ? "ON" : "OFF";
        actualizarVistaWindow(data.window);
      }
    });
  }

  const botonesEstado = document.querySelectorAll("button[data-estado]");

  botonesEstado.forEach(btn => {
    btn.addEventListener("click", async () => {
      if (!misionActual) return mostrarNotificacion("‚ö†Ô∏è Selecciona una misi√≥n", 'error');
      
      btn.disabled = true;
      const nuevoEstado = btn.dataset.estado;
      let updateData = { estado: nuevoEstado };

      if (nuevoEstado === "hold" || nuevoEstado === "scrub") {
        updateData.holdTime = new Date().toISOString();
      } else {
        updateData.holdTime = null;
      }

      try {
        await updateDoc(doc(db, "lanzamientos", misionActual.id), updateData);
        misionActual.estado = nuevoEstado;
        misionActual.holdTime = updateData.holdTime;
        
        if (nuevoEstado === "hold" || nuevoEstado === "scrub") {
          tiempoCongelado = new Date();
        } else {
          tiempoCongelado = null;
        }
        
        estadoElem.textContent = capitalize(nuevoEstado);
        estadoElem.className = `badge ${nuevoEstado}`;
        holdTimeElem.textContent = updateData.holdTime ? `‚è∏Ô∏è ${new Date(updateData.holdTime).toLocaleString('es-UY')}` : "";
        mostrarNotificacion(`‚úÖ Estado: ${capitalize(nuevoEstado)}`, 'success');
      } catch(e) {
        mostrarNotificacion(`‚ùå Error: ${e.message}`, 'error');
      } finally {
        btn.disabled = false;
      }
    });
  });

  switchTelemetria.addEventListener("change", async () => {
    if(!misionActual) return mostrarNotificacion("‚ö†Ô∏è Selecciona una misi√≥n", 'error');
    
    const nuevoEstado = switchTelemetria.checked;
    try {
      await updateDoc(doc(db, "lanzamientos", misionActual.id), {
        telemetria_on: nuevoEstado
      });
      labelTelemetria.textContent = nuevoEstado ? "ON" : "OFF";
      misionActual.telemetria_on = nuevoEstado;
      mostrarNotificacion(`üì° Telemetr√≠a ${nuevoEstado ? "ON" : "OFF"}`, 'success');
    } catch(e) {
      mostrarNotificacion(`‚ùå Error: ${e.message}`, 'error');
      switchTelemetria.checked = !nuevoEstado;
    }
  });

  form.addEventListener("submit", async e => {
    e.preventDefault();
    if(!lanzamientoId) return mostrarNotificacion("‚ö†Ô∏è Selecciona una misi√≥n", 'error');

    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;

    const fecha = form.fecha.value.split("-").reverse().join("/");
    const hora = form.hora.value;
    const utcTime = getLaunchUTC(fecha, hora).toISOString();

    try {
      await updateDoc(doc(db, "lanzamientos", lanzamientoId), {
        fecha,
        timeUTC: hora,
        utcTime
      });
      misionActual.fecha = fecha;
      misionActual.timeUTC = hora;
      mostrarNotificacion("‚úÖ T-0 actualizado", 'success');
    } catch(e) {
      mostrarNotificacion(`‚ùå Error: ${e.message}`, 'error');
    } finally {
      submitBtn.disabled = false;
    }
  });

  // Formulario de ventana de lanzamiento
  formWindow.addEventListener("submit", async e => {
    e.preventDefault();
    if(!lanzamientoId) return mostrarNotificacion("‚ö†Ô∏è Selecciona una misi√≥n", 'error');

    const submitBtn = formWindow.querySelector('button[type="submit"]');
    submitBtn.disabled = true;

    const startDate = formWindow.windowStartDate.value;
    const startTime = formWindow.windowStartTime.value;
    const endDate = formWindow.windowEndDate.value;
    const endTime = formWindow.windowEndTime.value;

    const startISO = new Date(`${startDate}T${startTime}:00.000Z`).toISOString();
    const endISO = new Date(`${endDate}T${endTime}:00.000Z`).toISOString();

    try {
      await updateDoc(doc(db, "lanzamientos", lanzamientoId), {
        window: {
          start: startISO,
          end: endISO
        }
      });
      misionActual.window = { start: startISO, end: endISO };
      mostrarNotificacion("‚úÖ Ventana de lanzamiento establecida", 'success');
    } catch(e) {
      mostrarNotificacion(`‚ùå Error: ${e.message}`, 'error');
    } finally {
      submitBtn.disabled = false;
    }
  });

  // Eliminar ventana
  btnEliminarWindow.addEventListener("click", async () => {
    if(!lanzamientoId) return mostrarNotificacion("‚ö†Ô∏è Selecciona una misi√≥n", 'error');
    
    if(!confirm("¬øEliminar la ventana de lanzamiento?")) return;
    
    btnEliminarWindow.disabled = true;

    try {
      await updateDoc(doc(db, "lanzamientos", lanzamientoId), {
        window: null
      });
      misionActual.window = null;
      mostrarNotificacion("‚úÖ Ventana eliminada", 'success');
    } catch(e) {
      mostrarNotificacion(`‚ùå Error: ${e.message}`, 'error');
    } finally {
      btnEliminarWindow.disabled = false;
    }
  });
});
  </script>

  <style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
  background: #0d0d0d;
  color: #e0e0e0;
  padding: 1rem;
  max-width: 800px;
  margin: 0 auto;
}

h1 {
  font-size: 1.5rem;
  margin-bottom: 1rem;
  color: #00ffcc;
}

.section {
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 6px;
  padding: 0.75rem;
  margin-bottom: 0.75rem;
}

.section-title {
  font-size: 0.9rem;
  color: #888;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

select, input {
  width: 100%;
  padding: 0.5rem;
  background: #0a0a0a;
  color: #fff;
  border: 1px solid #333;
  border-radius: 4px;
  font-size: 0.95rem;
}

select:focus, input:focus {
  outline: none;
  border-color: #00ffcc;
}

.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
}

.info-label {
  color: #888;
  font-size: 0.9rem;
}

.badge {
  padding: 0.25rem 0.75rem;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: bold;
  text-transform: uppercase;
}

.badge.programado { background: #0066ff; color: #fff; }
.badge.hold { background: #ffcc00; color: #000; }
.badge.scrub { background: #ff4444; color: #fff; }
.badge.exito { background: #00cc66; color: #fff; }
.badge.fallo { background: #990000; color: #fff; }
.badge.en.vuelo { background: #0066ff; color: #fff; }

#contadorDisplay {
  text-align: center;
  font-size: 2.5rem;
  font-weight: bold;
  color: #00ffcc;
  font-family: 'Courier New', monospace;
  padding: 1rem 0;
}

#holdTime {
  text-align: center;
  color: #ffcc00;
  font-size: 0.85rem;
  margin-top: 0.25rem;
}

.switch-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.switch {
  position: relative;
  display: inline-block;
  width: 44px;
  height: 24px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #444;
  transition: 0.3s;
  border-radius: 24px;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: 0.3s;
  border-radius: 50%;
}

input:checked + .slider {
  background-color: #00cc66;
}

input:checked + .slider:before {
  transform: translateX(20px);
}

#labelTelemetria {
  margin-left: 0.5rem;
  font-size: 0.9rem;
  font-weight: bold;
  color: #888;
}

.form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
}

button {
  padding: 0.5rem 1rem;
  border: none;
  border-radius: 4px;
  font-size: 0.85rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
}

button:hover:not(:disabled) {
  opacity: 0.8;
  transform: translateY(-1px);
}

button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-submit {
  width: 100%;
  background: #00ffcc;
  color: #000;
}

.btn-danger {
  width: 100%;
  background: #ff4444;
  color: #fff;
}

.btn-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 0.5rem;
}

@media (max-width: 600px) {
  .btn-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

.btn-programado { background: #0066ff; color: #fff; }
.btn-hold { background: #ffcc00; color: #000; }
.btn-scrub { background: #ff4444; color: #fff; }
.btn-exito { background: #00cc66; color: #fff; }
.btn-fallo { background: #990000; color: #fff; }
.btn-envuelo { background: #0066ff; color: #fff; }
.btn-reciclar { background: #00ffcc; color: #000; }

.notificacion {
  position: fixed;
  top: 1rem;
  right: 1rem;
  padding: 0.75rem 1rem;
  border-radius: 4px;
  font-size: 0.9rem;
  font-weight: bold;
  z-index: 1000;
  display: none;
  box-shadow: 0 2px 10px rgba(0,0,0,0.5);
}

.notificacion.success {
  background: #00cc66;
  color: #fff;
}

.notificacion.error {
  background: #ff4444;
  color: #fff;
}

.window-display {
  background: #0a0a0a;
  padding: 0.75rem;
  border-radius: 4px;
  border: 1px solid #333;
}

.window-info {
  display: flex;
  justify-content: space-between;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}

.window-info span:first-child {
  color: #888;
}

.window-info span:last-child {
  color: #00ffcc;
  font-family: monospace;
}
  </style>
</head>
<body>
  <h1>üöÄ Control de Lanzamiento</h1>

  <div class="section">
    <div class="section-title">Misi√≥n</div>
    <select id="selectorMision">
      <option value="">-- Selecciona --</option>
    </select>
  </div>

  <div class="section">
    <div id="contadorDisplay">--:--:--</div>
    <div id="holdTime"></div>
  </div>

  <div class="section" id="windowSection">
    <div class="section-title">ü™ü Ventana de Lanzamiento</div>
    
    <div id="windowDisplay" class="window-display" style="display: none;">
      <div class="window-info">
        <span>Inicio:</span>
        <span id="windowStart">--</span>
      </div>
      <div class="window-info">
        <span>Fin:</span>
        <span id="windowEnd">--</span>
      </div>
      <div class="window-info">
        <span>Duraci√≥n:</span>
        <span id="windowDuration">--</span>
      </div>
    </div>

    <form id="formWindow" style="display: none;">
      <div class="form-grid">
        <input type="date" name="windowStartDate" required>
        <input type="time" name="windowStartTime" step="1" required>
      </div>
      <div class="form-grid">
        <input type="date" name="windowEndDate" required>
        <input type="time" name="windowEndTime" step="1" required>
      </div>
      <button type="submit" class="btn-submit">Establecer Ventana</button>
    </form>

    <button id="btnEliminarWindow" class="btn-danger" style="display: none; margin-top: 0.5rem;">Eliminar Ventana</button>
  </div>

  <div class="section">
    <div class="section-title">Control de Estado</div>
    <div class="btn-grid">
      <button class="btn-programado" data-estado="programado">Programado</button>
      <button class="btn-hold" data-estado="hold">Hold</button>
      <button class="btn-scrub" data-estado="scrub">Scrub</button>
      <button class="btn-exito" data-estado="exito">√âxito</button>
      <button class="btn-fallo" data-estado="fallo">Fallo</button>
      <button class="btn-envuelo" data-estado="en vuelo">En Vuelo</button>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Modificar T-0</div>
    <form id="formT0">
      <div class="form-grid">
        <input type="date" name="fecha" required>
        <input type="time" name="hora" step="1" required>
      </div>
      <button type="submit" class="btn-submit">Actualizar</button>
    </form>
  </div>

  <div class="section">
    <div class="info-row">
      <span class="info-label">Estado</span>
      <span id="estadoActual" class="badge">Desconocido</span>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Telemetr√≠a</div>
    <div class="switch-row">
      <span>üì° Transmisi√≥n</span>
      <div style="display: flex; align-items: center;">
        <label class="switch">
          <input type="checkbox" id="switchTelemetria">
          <span class="slider"></span>
        </label>
        <span id="labelTelemetria">OFF</span>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="info-row">
      <span class="info-label">ID</span>
      <span id="lanzamientoId" style="font-family: monospace; font-size: 0.85rem; color: #00ffcc; cursor: pointer;" title="Click para copiar">--</span>
    </div>
  </div>

  <div id="notificacion" class="notificacion"></div>
</body>
</html>