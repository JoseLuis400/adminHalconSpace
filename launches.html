<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Editar Lanzamientos</title>
<link rel="shortcut icon" href="https://halconspace.site/img/logo.png" type="image/x-icon">
<style>
/* RESET B√ÅSICO */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
  color: #fff;
  padding: 30px;
  min-height: 100vh;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
}

h1 {
  text-align: center;
  margin-bottom: 40px;
  font-size: 2.5rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Header con botones */
.header-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 15px;
}

.btn-nuevo {
  padding: 12px 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  transition: transform 0.2s, box-shadow 0.2s;
}

.btn-nuevo:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

.search-box {
  position: relative;
  flex: 1;
  max-width: 400px;
}

.search-box input {
  width: 100%;
  padding: 12px 40px 12px 15px;
  border-radius: 8px;
  border: 1px solid #333;
  background-color: #1e1e1e;
  color: #fff;
  font-size: 14px;
}

.search-box::after {
  content: "üîç";
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 1000;
  overflow-y: auto;
  padding: 20px;
}

.modal.active {
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background-color: #1b1b1b;
  padding: 30px;
  border-radius: 15px;
  box-shadow: 0 10px 50px rgba(0,0,0,0.8);
  width: 100%;
  max-width: 900px;
  max-height: 90vh;
  overflow-y: auto;
  position: relative;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}

.modal-header h2 {
  margin: 0;
  color: #667eea;
}

.close-modal {
  background: none;
  border: none;
  color: #fff;
  font-size: 28px;
  cursor: pointer;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: background 0.2s;
}

.close-modal:hover {
  background: rgba(255,255,255,0.1);
}

/* Formulario */
form {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

form label {
  font-weight: bold;
  margin-bottom: 8px;
  font-size: 14px;
  color: #a0a0a0;
}

form input, form select, form textarea {
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #333;
  background-color: #2a2a2a;
  color: #fff;
  font-size: 14px;
  transition: border-color 0.2s, background-color 0.2s;
}

form input:focus, form select:focus, form textarea:focus {
  outline: none;
  border-color: #667eea;
  background-color: #333;
}

input[type="date"]::-webkit-calendar-picker-indicator,
input[type="time"]::-webkit-calendar-picker-indicator {
  filter: invert(1);
  cursor: pointer;
}

form textarea {
  resize: vertical;
  min-height: 80px;
}

.form-actions {
  grid-column: 1 / -1;
  display: flex;
  gap: 15px;
  justify-content: flex-end;
  margin-top: 10px;
}

button[type="submit"] {
  padding: 12px 30px;
  font-weight: bold;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

button[type="submit"]:hover {
  transform: translateY(-2px);
  box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
}

.btn-cancelar {
  padding: 12px 30px;
  font-weight: bold;
  background: #333;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.2s;
}

.btn-cancelar:hover {
  background: #444;
}

/* Grid de misiones */
.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
  padding: 20px;
  border-radius: 10px;
  text-align: center;
}

.stat-card h3 {
  font-size: 14px;
  color: #a0c4ff;
  margin-bottom: 10px;
}

.stat-card .number {
  font-size: 32px;
  font-weight: bold;
  color: #fff;
}

#misionesContainer {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 20px;
  margin-top: 30px;
}

.card-mision {
  background: linear-gradient(145deg, #1e1e1e 0%, #2a2a2a 100%);
  border-radius: 12px;
  padding: 0;
  overflow: hidden;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  transition: transform 0.3s, box-shadow 0.3s;
  position: relative;
}

.card-mision:hover {
  transform: translateY(-5px);
  box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}

.card-mision img {
  width: 100%;
  height: 200px;
  object-fit: cover;
}

.card-content {
  padding: 20px;
}

.card-mision h3 {
  margin-bottom: 15px;
  font-size: 1.3rem;
  color: #fff;
}

.info-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 14px;
}

.info-label {
  color: #a0a0a0;
  font-weight: 500;
}

.info-value {
  color: #fff;
  font-weight: 600;
}

.estado-badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: bold;
  text-transform: uppercase;
}

.estado-programado { background: #ffa726; color: #000; }
.estado-en-vuelo { background: #29b6f6; color: #000; }
.estado-exito { background: #66bb6a; color: #000; }
.estado-fallido { background: #ef5350; color: #fff; }

.contador {
  font-weight: bold;
  font-size: 18px;
  margin: 15px 0;
  padding: 10px;
  background: rgba(102, 126, 234, 0.2);
  border-radius: 8px;
  text-align: center;
  font-family: 'Courier New', monospace;
  color: #667eea;
}

.card-actions {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}

.btn-editar, .btn-eliminar {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-weight: bold;
  transition: background 0.2s;
}

.btn-editar {
  background: #667eea;
  color: #fff;
}

.btn-editar:hover {
  background: #5568d3;
}

.btn-eliminar {
  background: #ef5350;
  color: #fff;
}

.btn-eliminar:hover {
  background: #d32f2f;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.empty-state h3 {
  font-size: 24px;
  margin-bottom: 10px;
}

/* Loading */
.loading {
  display: none;
  text-align: center;
  padding: 40px;
  font-size: 18px;
  color: #667eea;
}

.loading.active {
  display: block;
}

/* Toast notifications */
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  padding: 15px 25px;
  background: #667eea;
  color: white;
  border-radius: 8px;
  box-shadow: 0 5px 20px rgba(0,0,0,0.3);
  z-index: 2000;
  animation: slideIn 0.3s ease;
  display: none;
}

.toast.active {
  display: block;
}

.toast.success { background: #66bb6a; }
.toast.error { background: #ef5350; }

.stat-card .small {
  margin-top: 4px;
  font-size: 12px;
  color: #a0c4ff;
  font-weight: normal;
  opacity: 0.8;
}

@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Responsivo */
@media (max-width: 768px) {
  body { padding: 15px; }
  h1 { font-size: 1.8rem; }
  
  #misionesContainer {
    grid-template-columns: 1fr;
  }
  
  .modal-content {
    padding: 20px;
  }
  
  form {
    grid-template-columns: 1fr;
  }
}

.header-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 15px;
}

.filter-group {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: #a0a0a0;
}

.filter-group label {
  white-space: nowrap;
}

.filter-group select {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #333;
  background-color: #1e1e1e;
  color: #fff;
  font-size: 14px;
  min-width: 140px;
  cursor: pointer;
  transition: border-color 0.2s;
}

.filter-group select:focus {
  outline: none;
  border-color: #667eea;
}

/* Responsive: en m√≥viles, apilar */
@media (max-width: 768px) {
  .header-actions {
    flex-direction: column;
    align-items: stretch;
  }
  .search-box,
  .filter-group {
    width: 100%;
  }
  .filter-group {
    justify-content: flex-start;
  }
}
</style>
</head>
<body>

<div class="container">
  <h1>üöÄ Panel Admin - Halcon Space</h1>

  <div class="stats">
    <!-- Estad√≠sticas originales -->
    <!-- CADENCIA (OPCIONAL) -->
    <div class="stat-card">
      <h3>Total Misiones</h3>
      <div class="number" id="totalMisiones">0</div>
      <p class="small" id="cadenciaGeneral">‚Äî</p>
    </div>
    <div class="stat-card">
      <h3>Programadas</h3>
      <div class="number" id="programadas">0</div>
    </div>
    <div class="stat-card">
      <h3>Exitosas</h3>
      <div class="number" id="exitosas">0</div>
    </div>
    <div class="stat-card">
      <h3>Fallidas</h3>
      <div class="number" id="fallidas">0</div>
    </div>
    <div class="stat-card">
      <h3>En Vuelo</h3>
      <div class="number" id="enVuelo">0</div>
    </div>
  
    <!-- NUEVAS ESTAD√çSTICAS -->
    <!-- Falcon 9 -->
<div class="stat-card">
  <h3>Falcon 9</h3>
  <div class="number" id="falcon9">0</div>
  <p class="small" id="cadenciaF9">‚Äî</p>
</div>

<!-- Falcon Heavy -->
<div class="stat-card">
  <h3>Falcon Heavy</h3>
  <div class="number" id="falconHeavy">0</div>
  <p class="small" id="cadenciaFH">‚Äî</p>
</div>
    <!-- LC-39A -->
<div class="stat-card">
  <h3>LC-39A</h3>
  <div class="number" id="lc39a">0</div>
  <p class="small" id="cadenciaLC39A">‚Äî</p>
</div>

<!-- SLC-40 -->
<div class="stat-card">
  <h3>SLC-40</h3>
  <div class="number" id="slc40">0</div>
  <p class="small" id="cadenciaSLC40">‚Äî</p>
</div>

<!-- SLC-4E -->
<div class="stat-card">
  <h3>SLC-4E</h3>
  <div class="number" id="slc4e">0</div>
  <p class="small" id="cadenciaSLC4E">‚Äî</p>
</div>

  </div>

  <div class="header-actions">
    <button class="btn-nuevo" onclick="abrirModal()">Nueva Misi√≥n</button>
  
    <!-- FILTROS -->
    <div class="filter-group">
      <label for="filterEstado">Estado:</label>
      <select id="filterEstado">
        <option value="todos">Todos</option>
        <option value="programado">Programadas</option>
        <option value="lanzadas">Lanzadas</option>
      </select>
    </div>
  
    <div class="filter-group">
      <label for="filterVehiculo">Veh√≠culo:</label>
      <select id="filterVehiculo">
        <option value="todos">Todos</option>
        <option value="Falcon 9 Block 5">Falcon 9</option>
        <option value="Falcon Heavy">Falcon Heavy</option>
      </select>
    </div>
    
  
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Buscar misiones...">
    </div>
  </div>

  <div class="loading" id="loading">Cargando misiones...</div>
  <div id="misionesContainer"></div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Nueva Misi√≥n</h2>
      <button class="close-modal" onclick="cerrarModal()">√ó</button>
    </div>
    
    <form id="formMision">
      <div class="form-group">
        <label for="nombre">Nombre *</label>
        <input type="text" id="nombre" placeholder="Starlink 6-73" required>
      </div>

      <div class="form-group">
        <label for="fecha">Fecha *</label>
        <input type="date" id="fecha" required>
      </div>

      <div class="form-group">
        <label for="timeUTC">Hora UTC *</label>
        <input type="time" id="timeUTC" step="1" value="00:00:00" required>
      </div>

      <div class="form-group">
        <label for="contador">Contador</label>
        <select id="contador">
          <option value="true">Activo</option>
          <option value="false">Desactivo</option>
        </select>
      </div>

      <div class="form-group">
        <label for="vehiculo">Veh√≠culo *</label>
        <select id="vehiculo" required>
          <option value="Falcon 9 Block 5">Falcon 9 Block 5</option>
          <option value="Falcon Heavy">Falcon Heavy</option>
          <option value="Cargo Dragon">Cargo Dragon</option>
          <option value="Crew Dragon">Crew Dragon</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div class="form-group">
        <label for="estado">Estado *</label>
        <select id="estado" required>
          <option value="programado">Programado</option>
          <option value="en vuelo">En vuelo</option>
          <option value="exito">√âxito</option>
          <option value="fallido">Fallido</option>
        </select>
      </div>

      <div class="form-group">
        <label for="plataforma">Plataforma *</label>
        <select id="plataforma" required>
          <option value="">-- Selecciona plataforma --</option>
          <option value="LC-39A">LC-39A</option>
          <option value="SLC-40">SLC-40</option>
          <option value="SLC-4E">SLC-4E</option>
        </select>
      </div>

      <div class="form-group full-width">
        <label for="imagen">URL Imagen</label>
        <input type="text" id="imagen" placeholder="https://ejemplo.com/imagen.jpg">
      </div>

      <div class="form-group full-width">
        <label for="alt">Texto alternativo</label>
        <input type="text" id="alt" placeholder="Descripci√≥n de la imagen">
      </div>

      <div class="form-group">
        <label for="detalleUrl">Detalle URL</label>
        <input type="text" id="detalleUrl" placeholder="/lanzamientos/xyz">
      </div>

      <div class="form-group">
        <label for="stream">Stream URL</label>
        <input type="url" id="stream" placeholder="https://youtube.com/watch?v=...">
      </div>

      <div class="form-group full-width">
        <label for="tieneVentana">
          <input type="checkbox" id="tieneVentana" style="width: auto; margin-right: 8px;">
          Tiene ventana de lanzamiento
        </label>
      </div>

      <div id="ventanaFields" style="display: none; grid-column: 1 / -1; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <div class="form-group">
          <label for="ventanaStart">Inicio de ventana (UTC)</label>
          <input type="time" id="ventanaStart" step="1">
        </div>
        <div class="form-group">
          <label for="ventanaEnd">Fin de ventana (UTC)</label>
          <input type="time" id="ventanaEnd" step="1">
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn-cancelar" onclick="cerrarModal()">Cancelar</button>
        <button type="submit">üíæ Guardar Misi√≥n</button>
      </div>
    </form>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getFirestore, collection, doc, getDocs, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
  
  const firebaseConfig = {
    apiKey: "AIzaSyAiLw2zwfsjdMP-IlEoE5JugyFvmaQLFC0",
    authDomain: "halcon-space-348e7.firebaseapp.com",
    projectId: "halcon-space-348e7",
    storageBucket: "halcon-space-348e7.firebasestorage.app",
    messagingSenderId: "741724706453",
    appId: "1:741724706453:web:519531e63f2b923f952d9c",
    measurementId: "G-VG1Y2YMY4W"
  };
  
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  
  const formMision = document.getElementById("formMision");
  const misionesContainer = document.getElementById("misionesContainer");
  const searchInput = document.getElementById("searchInput");
  const loading = document.getElementById("loading");
  const tieneVentana = document.getElementById("tieneVentana");
  const ventanaFields = document.getElementById("ventanaFields");
  
  let currentId = null;
  let allMisiones = [];
  let contadorInterval = null;
  
  // === FILTROS GLOBALES ===
  let filtroEstado = 'todos';
  let filtroVehiculo = 'todos';
  
  // === EVENTOS DE FILTRO ===
  document.getElementById('filterEstado').addEventListener('change', (e) => {
    filtroEstado = e.target.value;
    aplicarFiltros();
  });
  
  document.getElementById('filterVehiculo').addEventListener('change', (e) => {
    filtroVehiculo = e.target.value;
    aplicarFiltros();
  });
  
  // === B√öSQUEDA EN TIEMPO REAL ===
  searchInput.addEventListener('input', () => {
    aplicarFiltros();
  });
  
  // === FUNCI√ìN CENTRAL DE FILTRADO ===
  function aplicarFiltros() {
    const query = searchInput.value.toLowerCase().trim();
  
    const filtradas = allMisiones.filter(m => {
      // Filtro por texto
      const coincideTexto = 
        m.nombre.toLowerCase().includes(query) ||
        m.vehiculo.toLowerCase().includes(query) ||
        m.estado.toLowerCase().includes(query);
  
      // Filtro por estado
      const coincideEstado = 
        filtroEstado === 'todos' ||
        (filtroEstado === 'programado' && m.estado === 'programado') ||
        (filtroEstado === 'lanzadas' && ['exito', 'fallido', 'en vuelo'].includes(m.estado));
  
      // Filtro por veh√≠culo
      const coincideVehiculo = 
        filtroVehiculo === 'todos' ||
        m.vehiculo === filtroVehiculo;
  
      return coincideTexto && coincideEstado && coincideVehiculo;
    });
  
    renderizarMisiones(filtradas);
    if (query || filtroEstado !== 'todos' || filtroVehiculo !== 'todos') {
      iniciarContadores();
    }
  }
  
  // Toggle ventana fields
  tieneVentana.addEventListener('change', (e) => {
    if (e.target.checked) {
      ventanaFields.style.display = 'grid';
    } else {
      ventanaFields.style.display = 'none';
      document.getElementById('ventanaStart').value = '';
      document.getElementById('ventanaEnd').value = '';
    }
  });
  
  // Funciones auxiliares
  function capitalize(str) {
    if (!str) return "";
    return str.charAt(0).toUpperCase() + str.slice(1);
  }
  
  function formatoFechaInput(fechaStr) {
    const [dia, mes, anio] = fechaStr.split("/").map(Number);
    return `${anio.toString().padStart(4,'0')}-${mes.toString().padStart(2,'0')}-${dia.toString().padStart(2,'0')}`;
  }
  
  function normalizeURL(url) {
    if (!url) return "https://via.placeholder.com/400x200?text=Sin+imagen";
    url = url.trim();
    if (url.startsWith("http://") || url.startsWith("https://")) return url;
    if (!url.startsWith("/")) url = "/" + url;
    return `https://halconspace.site${url}`;
  }
  
  // Funci√≥n para obtener fecha y hora completa
  function getFechaHora(lanzamiento) {
    if (lanzamiento.utcTime) {
      return new Date(lanzamiento.utcTime);
    }
    const fechaStr = lanzamiento.fecha;
    const timeStr = lanzamiento.timeUTC || "00:00:00";
    
    if (!fechaStr) return new Date(0);
    const partes = fechaStr.split("/");
    if (partes.length !== 3) return new Date(0);
    const [dia, mes, anio] = partes.map(Number);
    if (isNaN(dia) || isNaN(mes) || isNaN(anio)) return new Date(0);
    
    const [h, m, s] = timeStr.split(":").map(Number);
    return new Date(Date.UTC(anio, mes - 1, dia, h || 0, m || 0, s || 0));
  }
  
  function getLaunchUTC(fechaStr, timeStr) {
    const [day, month, year] = fechaStr.split("/").map(Number);
    const [hours = 0, minutes = 0, seconds = 0] = (timeStr || "00:00:00").split(":").map(Number);
    return new Date(Date.UTC(year, month - 1, day, hours, minutes, seconds));
  }
  
  function calcularContador(fechaStr, timeStr) {
    const lanzamiento = getLaunchUTC(fechaStr, timeStr);
    const ahora = new Date();
    const ahoraUTC = new Date(Date.UTC(
      ahora.getUTCFullYear(),
      ahora.getUTCMonth(),
      ahora.getUTCDate(),
      ahora.getUTCHours(),
      ahora.getUTCMinutes(),
      ahora.getUTCSeconds()
    ));
  
    let diff = lanzamiento - ahoraUTC;
    let signo = "T-";
    if(diff < 0) {
      signo = "T+";
      diff = Math.abs(diff);
    }
  
    const dias = Math.floor(diff / 86400000);
    const horas = String(Math.floor((diff % 86400000) / 3600000)).padStart(2, "0");
    const minutos = String(Math.floor((diff % 3600000) / 60000)).padStart(2, "0");
    const segundos = String(Math.floor((diff % 60000) / 1000)).padStart(2, "0");
  
    if (dias > 0) {
      return `${signo}${dias}d ${horas}:${minutos}:${segundos}`;
    }
    return `${signo}${horas}:${minutos}:${segundos}`;
  }
  
  function showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast ${type} active`;
    setTimeout(() => {
      toast.className = 'toast';
    }, 3000);
  }
  
  window.abrirModal = function(id = null) {
    currentId = id;
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modalTitle');
    
    if (id) {
      modalTitle.textContent = 'Editar Misi√≥n';
      cargarDatosMision(id);
    } else {
      modalTitle.textContent = 'Nueva Misi√≥n';
      formMision.reset();
      formMision.timeUTC.value = "00:00:00";
    }
    
    // Reiniciar filtros
    document.getElementById('filterEstado').value = 'todos';
    document.getElementById('filterVehiculo').value = 'todos';
    filtroEstado = 'todos';
    filtroVehiculo = 'todos';
    searchInput.value = '';
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }
  
  window.cerrarModal = function() {
    const modal = document.getElementById('modal');
    modal.classList.remove('active');
    document.body.style.overflow = '';
    formMision.reset();
    currentId = null;
  }
  
  async function cargarDatosMision(id) {
    const mision = allMisiones.find(m => m.id === id);
    if (!mision) return;
  
    formMision.nombre.value = mision.nombre;
    formMision.fecha.value = formatoFechaInput(mision.fecha);
    formMision.timeUTC.value = mision.timeUTC || "00:00:00";
    formMision.contador.value = mision.contador !== undefined ? String(mision.contador) : "false";
    formMision.vehiculo.value = mision.vehiculo;
    formMision.estado.value = mision.estado;
    formMision.plataforma.value = mision.plataforma || "";
    formMision.imagen.value = mision.imagen || "";
    formMision.alt.value = mision.alt || "";
    formMision.detalleUrl.value = mision.detalleUrl || "";
    formMision.stream.value = mision.stream || "";
  
    if (mision.window && mision.window.start && mision.window.end) {
      tieneVentana.checked = true;
      ventanaFields.style.display = 'grid';
      
      const startDate = new Date(mision.window.start);
      const endDate = new Date(mision.window.end);
      
      const startTime = `${String(startDate.getUTCHours()).padStart(2,'0')}:${String(startDate.getUTCMinutes()).padStart(2,'0')}:${String(startDate.getUTCSeconds()).padStart(2,'0')}`;
      const endTime = `${String(endDate.getUTCHours()).padStart(2,'0')}:${String(endDate.getUTCMinutes()).padStart(2,'0')}:${String(endDate.getUTCSeconds()).padStart(2,'0')}`;
      
      document.getElementById('ventanaStart').value = startTime;
      document.getElementById('ventanaEnd').value = endTime;
    } else {
      tieneVentana.checked = false;
      ventanaFields.style.display = 'none';
    }
  }
  
  async function eliminarMision(id) {
    if (!confirm('¬øEst√°s seguro de eliminar esta misi√≥n?')) return;
    
    try {
      await deleteDoc(doc(db, "lanzamientos", id));
      showToast('Misi√≥n eliminada correctamente', 'success');
      await cargarMisiones();
    } catch (error) {
      console.error('Error al eliminar:', error);
      showToast('Error al eliminar la misi√≥n', 'error');
    }
  }
  
  // === FUNCI√ìN PARA CALCULAR CADENCIA ===
  function calcularCadencia(misionesFiltradas) {
    const completadas = misionesFiltradas
      .filter(m => m.estado === 'exito' || m.estado === 'fallido')
      .map(m => getFechaHora(m).getTime())
      .sort((a, b) => a - b);
  
    if (completadas.length < 2) return '‚Äî';
  
    const primer = completadas[0];
    const ultimo = completadas[completadas.length - 1];
    const diasTotales = (ultimo - primer) / (1000 * 60 * 60 * 24);
    const promedio = diasTotales / (completadas.length - 1);
  
    return promedio < 1 
      ? `${(promedio * 24).toFixed(1)}h`
      : `${promedio.toFixed(1)}d`;
  }
  
  function actualizarEstadisticas() {
    const total = allMisiones.length;
    const programadas = allMisiones.filter(m => m.estado === 'programado').length;
    const exitosas = allMisiones.filter(m => m.estado === 'exito').length;
    const enVuelo = allMisiones.filter(m => m.estado === 'en vuelo').length;
    const fallidas = allMisiones.filter(m => m.estado === 'fallido').length;
  
    const misionesReales = allMisiones.filter(m => 
      m.estado === 'exito' || m.estado === 'fallido' || m.estado === 'en vuelo'
    );
  
    const falcon9 = misionesReales.filter(m => m.vehiculo === 'Falcon 9 Block 5');
    const falconHeavy = misionesReales.filter(m => m.vehiculo === 'Falcon Heavy');
    const lc39a = misionesReales.filter(m => m.plataforma === 'LC-39A');
    const slc40 = misionesReales.filter(m => m.plataforma === 'SLC-40');
    const slc4e = misionesReales.filter(m => m.plataforma === 'SLC-4E');
  
    // === CADENCIA GENERAL ===
    const completadas = misionesReales
      .filter(m => m.estado === 'exito' || m.estado === 'fallido')
      .map(m => getFechaHora(m).getTime())
      .sort((a, b) => a - b);
  
    let cadenciaGeneral = '‚Äî';
    if (completadas.length >= 2) {
      const diasTotales = (completadas[completadas.length - 1] - completadas[0]) / (1000 * 60 * 60 * 24);
      const promedio = diasTotales / (completadas.length - 1);
      cadenciaGeneral = promedio < 1 ? `${(promedio * 24).toFixed(1)}h` : `${promedio.toFixed(1)}d`;
    }
  
    // === CADENCIA POR TIPO ===
    const cadenciaF9 = calcularCadencia(falcon9);
    const cadenciaFH = calcularCadencia(falconHeavy);
    const cadenciaLC39A = calcularCadencia(lc39a);
    const cadenciaSLC40 = calcularCadencia(slc40);
    const cadenciaSLC4E = calcularCadencia(slc4e);
  
    // === ACTUALIZAR DOM ===
    document.getElementById('totalMisiones').textContent = total;
    document.getElementById('cadenciaGeneral').textContent = cadenciaGeneral;
  
    document.getElementById('programadas').textContent = programadas;
    document.getElementById('exitosas').textContent = exitosas;
    document.getElementById('enVuelo').textContent = enVuelo;
    document.getElementById('fallidas').textContent = fallidas;
  
    document.getElementById('falcon9').textContent = falcon9.length;
    document.getElementById('falconHeavy').textContent = falconHeavy.length;
    document.getElementById('lc39a').textContent = lc39a.length;
    document.getElementById('slc40').textContent = slc40.length;
    document.getElementById('slc4e').textContent = slc4e.length;
  
    document.getElementById('cadenciaF9').textContent = cadenciaF9;
    document.getElementById('cadenciaFH').textContent = cadenciaFH;
    document.getElementById('cadenciaLC39A').textContent = cadenciaLC39A;
    document.getElementById('cadenciaSLC40').textContent = cadenciaSLC40;
    document.getElementById('cadenciaSLC4E').textContent = cadenciaSLC4E;
  }
  
  function renderizarMisiones(misiones) {
    if (misiones.length === 0) {
      misionesContainer.innerHTML = `
        <div class="empty-state">
          <h3>No hay misiones</h3>
          <p>Crea tu primera misi√≥n usando el bot√≥n "Nueva Misi√≥n"</p>
        </div>
      `;
      return;
    }
  
    misionesContainer.innerHTML = misiones.map(m => {
      let ventanaHTML = '';
      if (m.window && m.window.start && m.window.end) {
        const startDate = new Date(m.window.start);
        const endDate = new Date(m.window.end);
        const startTime = `${String(startDate.getUTCHours()).padStart(2,'0')}:${String(startDate.getUTCMinutes()).padStart(2,'0')}`;
        const endTime = `${String(endDate.getUTCHours()).padStart(2,'0')}:${String(endDate.getUTCMinutes()).padStart(2,'0')}`;
        ventanaHTML = `
          <div class="info-row">
            <span class="info-label">Ventana:</span>
            <span class="info-value">${startTime} - ${endTime} UTC</span>
          </div>
        `;
      }
  
      return `
      <div class="card-mision" data-id="${m.id}" data-contador="${m.contador ? 'true' : 'false'}" 
           data-fecha="${m.fecha}" data-timeutc="${m.timeUTC || '00:00:00'}">
        <img src="${normalizeURL(m.imagen)}" alt="${m.alt || ''}" onerror="this.src='https://via.placeholder.com/400x200?text=Error+al+cargar'">
        <div class="card-content">
          <h3>${m.nombre}</h3>
          
          <div class="info-row">
            <span class="info-label">Estado:</span>
            <span class="estado-badge estado-${m.estado.replace(' ', '-')}">${capitalize(m.estado)}</span>
          </div>
          
          <div class="info-row">
            <span class="info-label">Fecha:</span>
            <span class="info-value">${m.fecha}</span>
          </div>
          
          <div class="info-row">
            <span class="info-label">Hora UTC:</span>
            <span class="info-value">${m.timeUTC || '00:00:00'}</span>
          </div>
  
          ${ventanaHTML}
          
          <div class="info-row">
            <span class="info-label">Veh√≠culo:</span>
            <span class="info-value">${m.vehiculo}</span>
          </div>
          
          <div class="info-row">
            <span class="info-label">Plataforma:</span>
            <span class="info-value">${m.plataforma || 'N/A'}</span>
          </div>
          
          <div class="contador" data-contador-elem></div>
          
          <div class="card-actions">
            <button class="btn-editar" onclick="abrirModal('${m.id}')">Editar</button>
            <button class="btn-eliminar" onclick="eliminarMision('${m.id}')">Eliminar</button>
          </div>
        </div>
      </div>
    `}).join('');
  
    window.eliminarMision = eliminarMision;
  }
  
  async function cargarMisiones() {
    loading.classList.add('active');
    
    try {
      const snap = await getDocs(collection(db, "lanzamientos"));
      allMisiones = snap.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
  
      allMisiones.sort((a, b) => {
        const fechaHoraA = getFechaHora(a);
        const fechaHoraB = getFechaHora(b);
        return fechaHoraB - fechaHoraA;
      });
  
      aplicarFiltros(); // Usa filtros actuales
      actualizarEstadisticas();
      iniciarContadores();
    } catch (error) {
      console.error('Error al cargar misiones:', error);
      showToast('Error al cargar las misiones', 'error');
    } finally {
      loading.classList.remove('active');
    }
  }
  
  function iniciarContadores() {
    if(contadorInterval) clearInterval(contadorInterval);
  
    contadorInterval = setInterval(() => {
      document.querySelectorAll(".card-mision").forEach(card => {
        const contadorElem = card.querySelector("[data-contador-elem]");
        contadorElem.textContent = calcularContador(card.dataset.fecha, card.dataset.timeutc);
      });
    }, 1000);
  }
  
  // Guardar misi√≥n
  formMision.addEventListener("submit", async e => {
    e.preventDefault();
  
    const fecha = formMision.fecha.value.split("-").reverse().join("/");
    const timeUTC = formMision.timeUTC.value;
    const utcTime = getLaunchUTC(fecha, timeUTC).toISOString();
  
    let windowObj = null;
    if (tieneVentana.checked) {
      const ventanaStart = document.getElementById('ventanaStart').value;
      const ventanaEnd = document.getElementById('ventanaEnd').value;
      
      if (ventanaStart && ventanaEnd) {
        const [day, month, year] = fecha.split("/").map(Number);
        
        const [startH, startM, startS] = ventanaStart.split(":").map(Number);
        const startDate = new Date(Date.UTC(year, month - 1, day, startH, startM, startS || 0));
        
        const [endH, endM, endS] = ventanaEnd.split(":").map(Number);
        const endDate = new Date(Date.UTC(year, month - 1, day, endH, endM, endS || 0));
        
        windowObj = {
          start: startDate.toISOString(),
          end: endDate.toISOString()
        };
      }
    }
  
    const data = {
      nombre: formMision.nombre.value.trim(),
      fecha,
      timeUTC,
      utcTime,
      contador: formMision.contador.value === "true",
      vehiculo: formMision.vehiculo.value,
      estado: formMision.estado.value,
      plataforma: formMision.plataforma.value,
      imagen: formMision.imagen.value || null,
      alt: formMision.alt.value || null,
      detalleUrl: formMision.detalleUrl.value || null,
      stream: formMision.stream.value || null,
      window: windowObj
    };
  
    try {
      if (!currentId) {
        const newDocRef = doc(collection(db, "lanzamientos"));
        await setDoc(newDocRef, data);
        showToast('Misi√≥n creada exitosamente', 'success');
      } else {
        await setDoc(doc(db, "lanzamientos", currentId), data);
        showToast('Misi√≥n actualizada exitosamente', 'success');
      }
  
      cerrarModal();
      await cargarMisiones();
    } catch (error) {
      console.error('Error al guardar:', error);
      showToast('Error al guardar la misi√≥n', 'error');
    }
  });
  
  // Cerrar modal con ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const modal = document.getElementById('modal');
      if (modal.classList.contains('active')) {
        cerrarModal();
      }
    }
  });
  
  // Inicializar
  cargarMisiones();
  </script>
</body>
</html>