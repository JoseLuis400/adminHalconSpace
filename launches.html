<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin - Editar Lanzamientos</title>
<link rel="shortcut icon" href="https://halconspace.site/img/logo.png" type="image/x-icon">
<style>
/* RESET BÁSICO */
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: #121212;
  color: #fff;
  padding: 30px;
  display: flex;
  flex-direction: column;
  align-items: center;
}

h1, h2 { margin-bottom: 20px; text-align: center; }

.form-section {
  background-color: #1b1b1b;
  padding: 30px;
  border-radius: 10px;
  margin-bottom: 30px;
  box-shadow: 0 0 20px rgba(0,0,0,0.6);
  width: 100%;
  max-width: 800px;
}

form {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

form label {
  display: block;
  font-weight: bold;
  margin-bottom: 5px;
}

form input, form select, form textarea {
  padding: 10px;
  border-radius: 5px;
  border: none;
  background-color: #1e1e1e;
  color: #fff;
  width: 100%;
  font-size: 14px;
}

input[type="date"]::-webkit-calendar-picker-indicator,
input[type="time"]::-webkit-calendar-picker-indicator {
    filter: invert(1); /* blanco sobre fondo oscuro */
    cursor: pointer;
}

form textarea {
  grid-column: 1 / -1;
  resize: vertical;
}

button {
  grid-column: 1 / -1;
  padding: 12px;
  font-weight: bold;
  background-color: #2196f3;
  color: #fff;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: background 0.3s;
}

button:hover {
  background-color: #1976d2;
}

#misionesContainer {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-top: 20px;
}

.card-mision {
  background-color: #1b1b1b;
  border-radius: 8px;
  padding: 15px;
  width: 300px;
  box-shadow: 0 0 10px rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
  align-items: center;
}

.card-mision img {
  width: 100%;
  border-radius: 5px;
  margin-bottom: 10px;
}

.card-mision h3 {
  margin-bottom: 5px;
  text-align: center;
}

.card-mision p {
  margin-bottom: 5px;
  text-align: center;
}

.card-mision button {
  margin-top: 10px;
  background-color: #2196f3;
  padding: 8px 12px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  color: #fff;
  font-weight: bold;
  transition: background 0.3s;
}

.card-mision button:hover {
  background-color: #1976d2;
}

.contador {
  font-weight: bold;
  font-size: 16px;
  margin-top: 5px;
}

/* Responsivo */
@media (max-width: 600px) {
  form {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<h1>Panel Admin - Halcon Space</h1>

<div class="form-section">
  <h2>Editar / Agregar misión</h2>
  <form id="formMision">
    <label for="nombre">Nombre</label>
    <input type="text" id="nombre" placeholder="Nombre de la misión" required>

    <label for="fecha">Fecha (DD/MM/YYYY)</label>
    <input type="date" id="fecha" required>

    <label for="timeUTC">Hora UTC (HH:MM:SS)</label>
    <input type="time" id="timeUTC" step="1" value="00:00:00" required>

    <label for="contador">Contador</label>
    <select id="contador">
      <option value="true">Activo</option>
      <option value="false">Desactivo</option>
    </select>

    <label for="vehiculo">Vehículo</label>
    <select id="vehiculo">
      <option value="Falcon 9 Block 5">Falcon 9 Block 5</option>
      <option value="Falcon Heavy">Falcon Heavy</option>
      <option value="Cargo Dragon">Cargo Dragon</option>
      <option value="Crew Dragon">Crew Dragon</option>
      <option value="Otro">Otro</option>
    </select>

    <label for="estado">Estado</label>
    <select id="estado">
      <option value="programado">Programado</option>
      <option value="en vuelo">En vuelo</option>
      <option value="exito">Éxito</option>
      <option value="fallido">Fallido</option>
    </select>

    <label for="plataforma">Plataforma</label>
    <select id="plataforma">
      <option value="">-- Selecciona plataforma --</option>
      <option value="LC-39A">LC-39A</option>
      <option value="SLC-40">SLC-40</option>
      <option value="SLC-41">SLC-4E</option>
    </select>

    <label for="imagen">URL Imagen</label>
    <input type="text" id="imagen" placeholder="https://...">

    <label for="alt">Texto alternativo</label>
    <input type="text" id="alt" placeholder="Descripción de la imagen">

    <label for="detalleUrl">Detalle URL</label>
    <input type="text" id="detalleUrl" placeholder="/lanzamientos/xyz">

    <label for="stream">Stream URL</label>
    <input type="text" id="stream" placeholder="https://...">

    <button type="submit">Guardar misión</button>
  </form>
</div>

<div id="misionesContainer"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, doc, getDocs, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// Configuración Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAiLw2zwfsjdMP-IlEoE5JugyFvmaQLFC0",
  authDomain: "halcon-space-348e7.firebaseapp.com",
  projectId: "halcon-space-348e7",
  storageBucket: "halcon-space-348e7.firebasestorage.app",
  messagingSenderId: "741724706453",
  appId: "1:741724706453:web:519531e63f2b923f952d9c",
  measurementId: "G-VG1Y2YMY4W"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const formMision = document.getElementById("formMision");
const misionesContainer = document.getElementById("misionesContainer");

let currentId = null;

// Función para capitalizar
function capitalize(str) {
  if (!str) return "";
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// Convierte fecha DD/MM/YYYY a YYYY-MM-DD para input date
function formatoFechaInput(fechaStr) {
  const [dia, mes, anio] = fechaStr.split("/").map(Number);
  return `${anio.toString().padStart(4,'0')}-${mes.toString().padStart(2,'0')}-${dia.toString().padStart(2,'0')}`;
}

// Normaliza URLs de imágenes
function normalizeURL(url) {
  if (!url) return "https://via.placeholder.com/300x150?text=Sin+imagen";
  url = url.trim();
  if (url.startsWith("http://") || url.startsWith("https://")) return url;
  if (!url.startsWith("/")) url = "/" + url;
  return `https://halconspace.site${url}`;
}

// Convierte fecha y hora de Firebase a Date UTC
function getLaunchUTC(fechaStr, timeStr) {
  const [day, month, year] = fechaStr.split("/").map(Number);
  const [hours = 0, minutes = 0, seconds = 0] = (timeStr || "00:00:00").split(":").map(Number);
  return new Date(Date.UTC(year, month - 1, day, hours, minutes, seconds));
}

// Calcula el contador estilo T-HH:MM:SS o T+HH:MM:SS
function calcularContador(fechaStr, timeStr) {
  const lanzamiento = getLaunchUTC(fechaStr, timeStr);
  const ahora = new Date();
  const ahoraUTC = new Date(Date.UTC(
    ahora.getUTCFullYear(),
    ahora.getUTCMonth(),
    ahora.getUTCDate(),
    ahora.getUTCHours(),
    ahora.getUTCMinutes(),
    ahora.getUTCSeconds()
  ));

  let diff = lanzamiento - ahoraUTC;
  let signo = "T-";
  if(diff < 0) {
    signo = "T+";
    diff = Math.abs(diff);
  }

  const horas = String(Math.floor(diff / 3600000)).padStart(2, "0");
  const minutos = String(Math.floor((diff % 3600000) / 60000)).padStart(2, "0");
  const segundos = String(Math.floor((diff % 60000) / 1000)).padStart(2, "0");

  return `${signo}${horas}:${minutos}:${segundos}`;
}

let contadorInterval = null;

async function mostrarMisiones() {
  const snap = await getDocs(collection(db, "lanzamientos"));
  const misiones = snap.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));

  // Orden descendente por fecha
  misiones.sort((a,b) => {
    const [dA,mA,yA] = a.fecha.split("/").map(Number);
    const [dB,mB,yB] = b.fecha.split("/").map(Number);
    return new Date(yB, mB-1, dB) - new Date(yA, mA-1, dA);
  });

  misionesContainer.innerHTML = "";

  misiones.forEach(m => {
    const card = document.createElement("div");
    card.className = "card-mision";
    card.dataset.id = m.id;
    card.dataset.contador = m.contador ? "true" : "false";
    card.dataset.fecha = m.fecha;
    card.dataset.timeutc = m.timeUTC || "00:00:00";

    card.innerHTML = `
      <img src="${normalizeURL(m.imagen)}" alt="${m.alt || ''}">
      <h3>${m.nombre}</h3>
      <p><strong>Estado:</strong> ${capitalize(m.estado)}</p>
      <p><strong>Fecha:</strong> ${m.fecha}</p>
      <p><strong>Hora UTC:</strong> ${m.timeUTC || '00:00:00'}</p>
      <p><strong>Vehículo:</strong> ${m.vehiculo}</p>
      <p><strong>Plataforma:</strong> ${m.plataforma || ''}</p>
      <p class="contador"></p>
      <button>Editar</button>
    `;
    card.querySelector("button").addEventListener("click", () => seleccionarMision(m.id));
    misionesContainer.appendChild(card);
  });

  // Limpiar interval anterior si existe
  if(contadorInterval) clearInterval(contadorInterval);

  // Actualizar contadores activos cada segundo
  contadorInterval = setInterval(() => {
    document.querySelectorAll(".card-mision").forEach(card => {
      const contadorElem = card.querySelector(".contador");
      const activo = card.dataset.contador === "true";
      if(activo) {
        contadorElem.textContent = calcularContador(card.dataset.fecha, card.dataset.timeutc);
      } else {
        contadorElem.textContent = "";
      }
    });
  }, 1000);
}


// Seleccionar misión en el form
async function seleccionarMision(id) {
  currentId = id;
  const docSnap = await getDocs(collection(db, "lanzamientos")).then(snap => snap.docs.find(d => d.id === id));
  const data = docSnap.data();

  formMision.nombre.value = data.nombre;
  formMision.fecha.value = formatoFechaInput(data.fecha);
  formMision.timeUTC.value = data.timeUTC || "00:00:00";
  formMision.contador.value = data.contador !== undefined ? String(data.contador) : "false";
  formMision.vehiculo.value = data.vehiculo;
  formMision.estado.value = data.estado;
  formMision.plataforma.value = data.plataforma || "";
  formMision.imagen.value = data.imagen || "";
  formMision.alt.value = data.alt || "";
  formMision.detalleUrl.value = data.detalleUrl || "";
  formMision.stream.value = data.stream || "";
}

// Guardar misión
formMision.addEventListener("submit", async e => {
  e.preventDefault();

  // Validar campos obligatorios
  const requiredFields = [
    { field: formMision.nombre, name: "Nombre" },
    { field: formMision.fecha, name: "Fecha" },
    { field: formMision.timeUTC, name: "Hora UTC" },
    { field: formMision.vehiculo, name: "Vehículo" },
    { field: formMision.estado, name: "Estado" },
    { field: formMision.plataforma, name: "Plataforma" },
    { field: formMision.contador, name: "Contador" }
  ];

  for (const f of requiredFields) {
    if (!f.field.value.trim()) {
      return alert(`El campo "${f.name}" es obligatorio.`);
    }
  }

  // Construir datos
  const fecha = formMision.fecha.value.split("-").reverse().join("/"); // DD/MM/YYYY
  const timeUTC = formMision.timeUTC.value;
  const utcTime = getLaunchUTC(fecha, timeUTC).toISOString();

  const data = {
    nombre: formMision.nombre.value.trim(),
    fecha,
    timeUTC,
    utcTime,
    contador: formMision.contador.value === "true",
    vehiculo: formMision.vehiculo.value,
    estado: formMision.estado.value,
    plataforma: formMision.plataforma.value,
    imagen: formMision.imagen.value || null,
    alt: formMision.alt.value || null,
    detalleUrl: formMision.detalleUrl.value || null, // puede estar vacío
    stream: formMision.stream.value || null         // puede estar vacío
  };

  if (!currentId) {
    // Crear nueva misión
    const newDocRef = doc(collection(db, "lanzamientos"));
    await setDoc(newDocRef, data);
    console.log("Nueva misión agregada: " + data.nombre);
  } else {
    // Editar misión existente
    await setDoc(doc(db, "lanzamientos", currentId), data);
    console.log("Misión actualizada: " + data.nombre);
  }

  formMision.reset();
  currentId = null;
  mostrarMisiones();
});


// Inicializar
mostrarMisiones();
</script>
</body>
</html>
